{% extends "base.html" %}
{% block title %}{{ habitacion.nombre }}{% endblock %}
{% block content %}

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<section class="py-16 sm:py-24">
  <div class="container mx-auto px-6 max-w-4xl">
    <div class="mb-8">
      <img src="{{ url_for('static', filename='img/' + habitacion.nombre|lower|replace(' ', '') + '.jpg') }}"
        alt="{{ habitacion.nombre }}" class="w-full h-96 object-cover rounded-xl shadow-lg">
    </div>

    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{{ habitacion.nombre }}</h2>
    <p class="text-gray-600 dark:text-gray-400 mb-2"><strong>Tipo:</strong> {{ habitacion.tipo }}</p>
    <p class="text-gray-600 dark:text-gray-400 mb-2"><strong>Precio:</strong> {{ habitacion.precio }}€/noche</p>

    {% if habitacion.descripcion %}
    <p class="text-gray-700 dark:text-gray-300 mt-4">{{ habitacion.descripcion }}</p>
    {% endif %}

    {% if habitacion.servicios %}
    <p class="text-gray-700 dark:text-gray-300 mt-4"><strong>Servicios:</strong> {{ habitacion.servicios }}</p>
    {% endif %}

    <hr class="my-8">

    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Reservar esta habitación</h3>

    <form id="form-reserva" action="{{ url_for('solicitar_reserva', habitacion_id=habitacion.id) }}" method="POST"
      class="space-y-6 bg-white dark:bg-gray-900 p-6 rounded-xl shadow-lg">
      <input type="hidden" name="habitacion_id" value="{{ habitacion.id }}">
      <div>
        <label for="rango_fechas" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecciona tu
          estancia</label>
        <input type="text" id="rango_fechas" name="rango_fechas" required
          class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-800" autocomplete="off" readonly>
        <input type="hidden" id="fecha_entrada" name="fecha_entrada">
        <input type="hidden" id="fecha_salida" name="fecha_salida">
      </div>

      <button type="submit" id="btn-confirmar" class="w-full px-5 py-3 text-sm font-bold bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors
      {% if not current_user.is_authenticated %}opacity-50 cursor-not-allowed{% endif %}" {% if not
        current_user.is_authenticated %}disabled{% endif %}>
        Preguntar por la disponibilidad de la habitación
      </button>

      {% if not current_user.is_authenticated %}
      <p class="text-sm text-red-600 mt-2">Debes iniciar sesión para enviar una solicitud de reserva.</p>
      {% endif %}

    </form>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const isAuthenticated = "{{ 'yes' if current_user.is_authenticated else 'no' }}" === "yes";
    const botonReserva = document.getElementById('btn-confirmar');
    const rangoInput = document.getElementById('rango_fechas');
    const inputEntrada = document.getElementById('fecha_entrada');
    const inputSalida = document.getElementById('fecha_salida');

    // Desactivar el botón al cargar
    botonReserva.disabled = true;
    botonReserva.classList.add('opacity-50', 'cursor-not-allowed');

    function formatLocalDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    let fpInstance = null;

    function initFlatpickr() {
      if (fpInstance && fpInstance.destroy) fpInstance.destroy();

      const wide = window.innerWidth >= 1280;

      fpInstance = flatpickr(rangoInput, {
        mode: "range",
        inline: wide,
        locale: "es",
        minDate: "today",
        dateFormat: "Y-m-d",
        showMonths: wide ? 2 : 1,
        allowInput: false,

        onChange: function (selectedDates) {
          if (selectedDates.length === 2) {
            const entrada = selectedDates[0];
            const salida = selectedDates[1];

            // Validar que la salida sea posterior a la entrada
            if (salida.getTime() === entrada.getTime()) {
              inputEntrada.value = "";
              inputSalida.value = "";
              botonReserva.disabled = true;
              botonReserva.classList.add('opacity-50', 'cursor-not-allowed');
              return;
            }
            inputEntrada.value = formatLocalDate(entrada);
            inputSalida.value = formatLocalDate(salida);

            if (isAuthenticated) {
              botonReserva.disabled = false;
              botonReserva.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
              botonReserva.disabled = true;
              botonReserva.classList.add('opacity-50', 'cursor-not-allowed');
            }
          } else {
            inputEntrada.value = "";
            inputSalida.value = "";
            botonReserva.disabled = true;
            botonReserva.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });
    }

    initFlatpickr();

    let lastWide = window.innerWidth >= 1280;
    window.addEventListener('resize', function () {
      const nowWide = window.innerWidth >= 1280;
      if (nowWide !== lastWide) {
        lastWide = nowWide;
        initFlatpickr();
      }
    });

    // Validación extra al enviar el formulario
    document.getElementById('form-reserva').addEventListener('submit', function (e) {
      if (!inputEntrada.value || !inputSalida.value) {
        e.preventDefault();
        alert("Por favor, selecciona una fecha de entrada y salida antes de enviar la solicitud.");
      }
    });
  });
</script>

{% endblock %}