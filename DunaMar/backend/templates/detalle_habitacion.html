{% extends "base.html" %}
{% block title %}{{ habitacion.nombre }}{% endblock %}
{% block content %}

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<section class="py-16 sm:py-24">
  <div class="container mx-auto px-6 max-w-4xl">
    <div class="mb-8">
      <img src="{{ url_for('static', filename='img/' + habitacion.nombre|lower|replace(' ', '') + '.jpg') }}"
        alt="{{ habitacion.nombre }}" class="w-full h-96 object-cover rounded-xl shadow-lg">
    </div>

    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{{ habitacion.nombre }}</h2>
    <p class="text-gray-600 dark:text-gray-400 mb-2"><strong>Tipo:</strong> {{ habitacion.tipo }}</p>
    <p class="text-gray-600 dark:text-gray-400 mb-2"><strong>Precio:</strong> {{ habitacion.precio }}€/noche</p>

    {% if habitacion.descripcion %}
    <p class="text-gray-700 dark:text-gray-300 mt-4">{{ habitacion.descripcion }}</p>
    {% endif %}

    {% if habitacion.servicios %}
    <p class="text-gray-700 dark:text-gray-300 mt-4"><strong>Servicios:</strong> {{ habitacion.servicios }}</p>
    {% endif %}

    <hr class="my-8">

    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Reservar esta habitación</h3>

    <form id="form-reserva" action="{{ url_for('formulario_reserva', habitacion_id=habitacion.id) }}" method="POST"
      class="space-y-6 bg-white dark:bg-gray-900 p-6 rounded-xl shadow-lg">
      <div>
        <label for="rango_fechas" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecciona tu
          estancia</label>
        <input type="text" id="rango_fechas" name="rango_fechas" required
          class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-800" autocomplete="off" readonly>
        <input type="hidden" id="fecha_entrada" name="fecha_entrada">
        <input type="hidden" id="fecha_salida" name="fecha_salida">
      </div>

      <p id="mensaje-disponibilidad" class="text-sm font-medium mb-4"></p>
      <button type="submit" id="btn-confirmar"
        class="w-full px-5 py-3 text-sm font-bold bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
        disabled>
        Confirmar reserva
      </button>
    </form>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const habitacionId = "{{ habitacion.id }}";
  const botonReserva = document.getElementById('btn-confirmar');
  const mensaje = document.getElementById('mensaje-disponibilidad');
  const rangoInput = document.getElementById('rango_fechas');
  const inputEntrada = document.getElementById('fecha_entrada');
  const inputSalida = document.getElementById('fecha_salida');

  let diasOcupados = [];
  let diasEntrada = [];

  function formatLocalDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  fetch(`/fechas_ocupadas/${habitacionId}`)
    .then(res => res.json())
    .then(data => {
      diasOcupados = data.ocupadas || [];
      diasEntrada = data.entradas || [];

      flatpickr(rangoInput, {
        mode: "range",
        inline: true,
        locale: "es",
        disable: diasOcupados,     // solo noches que realmente bloquean
        minDate: "today",
        dateFormat: "Y-m-d",
        showMonths: 2,

        onChange: function (selectedDates, dateStr, instance) {
          botonReserva.disabled = true;
          botonReserva.classList.add('opacity-50', 'cursor-not-allowed');
          mensaje.textContent = "";
          inputEntrada.value = "";
          inputSalida.value = "";

          if (selectedDates.length === 1) {
            const posibleInicio = formatLocalDate(selectedDates[0]);
            // regla de negocio: no permitir iniciar en fecha que ya sea entrada de otra reserva
            if (diasEntrada.includes(posibleInicio)) {
              mensaje.textContent = "⚠️ No puedes iniciar la reserva en este día (entrada de otra reserva).";
              mensaje.className = "text-sm font-medium mb-4 text-red-600";
              // limpiar selección visual
              setTimeout(() => instance.clear(), 250);
              return;
            }
          }

          if (selectedDates.length === 2) {
            const entrada = selectedDates[0];
            const salida = selectedDates[1];

            // recorrer desde entrada hasta salida - 1
            const ultimaNoche = new Date(salida);
            ultimaNoche.setDate(ultimaNoche.getDate() - 1);

            let actual = new Date(entrada);
            actual.setHours(0,0,0,0);
            ultimaNoche.setHours(0,0,0,0);

            let conflicto = false;
            while (actual <= ultimaNoche) {
              const fechaStr = formatLocalDate(actual);
              if (diasOcupados.includes(fechaStr) || diasEntrada.includes(fechaStr)) {
                conflicto = true;
                break;
              }
              actual.setDate(actual.getDate() + 1);
            }

            if (conflicto) {
              mensaje.textContent = "⚠️ Esta habitación está ocupada en ese rango de fechas.";
              mensaje.className = "text-sm font-medium mb-4 text-red-600";
            } else {
              mensaje.textContent = "✅ Esta habitación está disponible en esas fechas.";
              mensaje.className = "text-sm font-medium mb-4 text-green-600";
              // rellenar inputs ocultos para el POST usando formato local
              inputEntrada.value = formatLocalDate(selectedDates[0]);
              inputSalida.value = formatLocalDate(selectedDates[1]);
              botonReserva.disabled = false;
              botonReserva.classList.remove('opacity-50', 'cursor-not-allowed');
            }
          }
        },

        onDayCreate: function (_, __, ___, dayElem) {
          const fecha = new Date(dayElem.dateObj);
          const hoy = new Date();
          fecha.setHours(0,0,0,0);
          hoy.setHours(0,0,0,0);
          const fechaStr = formatLocalDate(fecha);

          if (diasEntrada.includes(fechaStr)) {
            dayElem.style.backgroundColor = "#000";
            dayElem.style.color = "#fff";
            dayElem.style.borderRadius = "50%";
          } else if (diasOcupados.includes(fechaStr)) {
            dayElem.style.backgroundColor = "#1f2937";
            dayElem.style.color = "#fff";
            dayElem.style.borderRadius = "50%";
          } else if (fecha < hoy) {
            dayElem.style.backgroundColor = "#e5e7eb";
            dayElem.style.color = "#888";
            dayElem.style.borderRadius = "50%";
          } else {
            dayElem.style.backgroundColor = "#d1fae5";
            dayElem.style.color = "#000";
            dayElem.style.borderRadius = "50%";
          }
        }
      });
    })
    .catch(err => {
      mensaje.textContent = "Error cargando disponibilidad.";
      mensaje.className = "text-sm font-medium mb-4 text-red-600";
      console.error(err);
    });
    

    // --- Añade esto dentro del mismo DOMContentLoaded, tras inicializar flatpickr ---
const form = document.getElementById('form-reserva');

if (form) {
  form.addEventListener('submit', async (e) => {
    // Si el botón está deshabilitado, permitir comportamiento por defecto (o evitar envío)
    if (botonReserva.disabled) {
      e.preventDefault();
      return;
    }

    // Interceptamos para enviar por AJAX
    e.preventDefault();
    botonReserva.disabled = true;
    botonReserva.classList.add('opacity-50','cursor-not-allowed');

    // Mensaje temporal
    mensaje.textContent = 'Enviando reserva...';
    mensaje.className = 'text-sm font-medium mb-4 text-gray-700';

    const formData = new FormData(form);

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        if (res.status === 409) {
          mensaje.textContent = data?.error || 'Conflicto de fechas. Elige otro rango.';
        } else if (res.status === 400) {
          mensaje.textContent = data?.error || 'Datos inválidos.';
        } else {
          mensaje.textContent = data?.error || 'Error del servidor. Inténtalo de nuevo más tarde.';
        }
        mensaje.className = 'text-sm font-medium mb-4 text-red-600';
        botonReserva.disabled = false;
        botonReserva.classList.remove('opacity-50','cursor-not-allowed');
        return;
      }

      // Éxito
      mensaje.textContent = data?.message || 'Reserva confirmada.';
      mensaje.className = 'text-sm font-medium mb-4 text-green-600';

      // Redirigir o actualizar UI tras breve espera
      setTimeout(() => { window.location.href = '/mis_reservas'; }, 900);

    } catch (err) {
      console.error(err);
      mensaje.textContent = 'Error de red. Comprueba tu conexión e inténtalo de nuevo.';
      mensaje.className = 'text-sm font-medium mb-4 text-red-600';
      botonReserva.disabled = false;
      botonReserva.classList.remove('opacity-50','cursor-not-allowed');
    }
  });
}


});
</script>

{% endblock %}